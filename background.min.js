var e={};function n(e){return e.replace(/\./g,'__DOT__').replace(/@/g,'__AT__').replace(/\+/g,'__PLUS__').replace(/~/g,'__TILDE__').replace(/!/g,'__BANG__').replace(/#/g,'__NUMBER__').replace(/%/g,'__PERCENT__').replace(/&/g,'__AMP__').replace(/'/g,'__QUOT__').replace(/\//g,'__SLASH__').replace(/=/g,'__EQ__')}e.indexedDB={},e.indexedDB.db=null,e.pendingRevisions={},e.getParameterByName=function(e,n){var t=RegExp('[?&]'+n+'=([^&]*)').exec(e);return t&&decodeURIComponent(t[1].replace(/\+/g,' '))},e.addPendingRevision=function(n,t){e.pendingRevisions[t]=n},e.getPendingRevision=function(n){return e.pendingRevisions[n]},e.deletePendingRevision=function(n){delete e.pendingRevisions[n]},Array.prototype.insert=function(e,n){this.splice(n,0,e)},Array.prototype.delete=function(e,n){return this.splice(e,n-e+1)},Array.prototype.last=function(){return this[this.length-1]},e.kills={},e.shouldKill=function(n){return!!e.kills[n]&&(delete e.kills[n],!0)},e.authorMaps={},e.autoincrements={},e.windows={},e.writing_sessions={},e.timelines={},e.computeTimeline=function(n,t){e.timelines[n]||(e.timelines[n]=[]);var i={},s=function(e){const n=e.tab||"t.0";return n in i||(i[n]=[]),i[n]};const o=['is','ds','iss','dss','msfd'];var r={is:function(e){for(var n=e.ibi,t=e.s,i=Array.from(t).map((function(e){return{s:e}})),o=0;o<t.length;o++)s(e).insert(i[o],n-1+o)},ds:function(e){var n=e.si,t=e.ei;s(e).delete(n-1,t-1)},iss:function(e){for(var n=e.ibi,t=e.s,i=Array.from(t).map((function(e){return{s:e,ty:"sug"}})),o=0;o<t.length;o++)s(e).insert(i[o],n-1+o)},dss:function(e){var n=e.si,t=e.ei;s(e).delete(n-1,t-1)},msfd:function(e){for(var n=e.si-1;n<=e.ei-1;n++)s(e)[n]&&(s(e)[n].ty="sugd")}},d=function(t){var i=r[t.ty];i&&o.includes(t.ty)&&i(t);var d=s(t).length,a=0;"is"===t.ty||"iss"===t.ty?a=t.ibi-1:"ds"!==t.ty&&"dss"!==t.ty||(a=t.si-1);var c={timestamp:t.timestamp,character_count:d,start_i:a},u=e.timelines[n].last();if(u){var l=!1;for(var m in u)u.hasOwnProperty(m)&&u[m]!=c[m]&&(l=!0);l&&e.timelines[n].push(c)}else e.timelines[n].push(c)};for(const e of t){const n=Object.assign(e[0],{timestamp:e[1],uid:e[2],revno:e[3]});if('mlti'===n.ty)for(const e of n.mts)['is','ds','iss','dss','msfd'].includes(e.ty)&&(e.revno||(e.revno=[n.revno,0].join('-')),e.timestamp=n.timestamp,e.uid=n.uid,d(e));else if('nm'===n.ty){const e=n.nmc;o.includes(e.ty)&&(e.revno||(e.revno=[n.revno,0].join('-')),e.timestamp=n.timestamp,e.uid=n.uid,e.tab=n.nmr[1],d(e))}else if('rplc'===n.ty)for(const e of n.snapshot)o.includes(e.ty)&&(e.revno||(e.revno=[n.revno,0].join('-')),e.timestamp=n.timestamp,e.uid=n.uid,d(e));else o.includes(n.ty)&&d(n)}},e.computeWritingSessions=function(n,t){e.writing_sessions[n]||(e.writing_sessions[n]={});var i=[];e.autoincrements[n]=0;const s=['is','ds','iss','dss','msfd'];for(const e of t){const n=Object.assign(e[0],{timestamp:e[1],uid:e[2],revno:e[3]});if('mlti'===n.ty)for(const e of n.mts)s.includes(e.ty)&&o(Object.assign(e,{timestamp:n.timestamp,uid:n.uid,revno:n.revno}));else if('nm'===n.ty){const e=n.nmc;s.includes(e.ty)&&o(Object.assign(e,{timestamp:n.timestamp,uid:n.uid,revno:n.revno}))}else if('rplc'===n.ty)for(const e of n.snapshot)s.includes(e.ty)&&o(Object.assign(e,{timestamp:n.timestamp,uid:n.uid,revno:n.revno}));else s.includes(n.ty)&&o(n)}function o(t){if(r=e.writing_sessions[n][t.uid]){if(t.timestamp-r.end<6e5)r.end=t.timestamp,r.end_revision=t.revno,r.count+=1;else{var s={seq:e.autoincrements[n]++,docId:n,uid:t.uid,start_revision:''+r.start_revision,end_revision:''+r.end_revision,start_timestamp:r.start,end_timestamp:r.end,duration:r.end-r.start,revisions_count:r.count};i.push(s),e.writing_sessions[n][t.uid]={start:t.timestamp,start_revision:t.revno,end:t.timestamp,end_revision:t.revno,count:1}}}else{for(var o in e.writing_sessions[n])if(e.writing_sessions[n].hasOwnProperty(o)){var r=e.writing_sessions[n][o];s={seq:e.autoincrements[n]++,docId:n,uid:o,start_revision:''+r.start_revision,end_revision:''+r.end_revision,start_timestamp:r.start,end_timestamp:r.end,duration:r.end-r.start,revisions_count:r.count};i.push(s),delete e.writing_sessions[n][o]}e.writing_sessions[n][t.uid]={start:t.timestamp,start_revision:t.revno,end:t.timestamp,end_revision:t.revno,count:1}}}for(var r in e.writing_sessions[n])if(e.writing_sessions[n].hasOwnProperty(r)){var d=e.writing_sessions[n][r],a={seq:e.autoincrements[n]++,docId:n,uid:r,start_revision:''+d.start_revision,end_revision:''+d.end_revision,start_timestamp:d.start,end_timestamp:d.end,duration:d.end-d.start,revisions_count:d.count};i.push(a),delete e.writing_sessions[n][r]}return i},e.precomputeStats=async function(n,t){var i={};for(const e of t){const n=Object.assign(e[0],{timestamp:e[1],uid:e[2],revno:e[3]});'ac'===n.ty?n.d&&n.d[0]&&n.d[1]&&n.d[1][1]&&(i[n.d[0]]=n.d[1][1]):'ucp'===n.ty&&n.d&&n.d[0]&&n.d[1]&&n.d[1][1]&&n.d[1][1][1]&&(i[n.d[0]]=n.d[1][1][1])}e.computeTimeline(n,t);var s=e.computeWritingSessions(n,t);let o=e.timelines[n];if(o.length>2500){const e=Math.ceil(o.length/2500),n=[];for(let t=0;t<o.length;t+=e)n.push(o[t]);o=n}e.indexedDB.db||await e.indexedDB.open(),await e.indexedDB.addTimeline({docId:n,timeline:o});for(const n of s)await e.indexedDB.addSession(n);return{timeline:o,sessions:s,tabNames:i}},e.render=function(n,t,i,s){return new Promise((o=>{var r=2500,d=!1,a=e.windows[i.docId],c=a[0],u=a[1],l=n.length;if("is"===t.ty||"iss"===t.ty)var m=(f=t.ibi-1)+t.s.length;else if("ds"===t.ty||"dss"===t.ty){var f=t.si-1;m=t.ei}if(u-c>3e3&&(c+=250,u-=250),m-f>r)var p=c,v=u;else if(f<c){var g=Math.max(f-100,0);e.windows[i.docId]=[g,g+r]}else if(m>u){var y=Math.min(m+100,l-1);e.windows[i.docId]=[y-r,y]}else"is"===t.ty||"iss"===t.ty?e.windows[i.docId]=[c,u+t.s.length]:"ds"!==t.ty&&"dss"!==t.ty||(d=[c,u-(m-f)]);var h=e.windows[i.docId],D=(p=h[0],v=h[1],"");l<35e3&&(D="<div class='progress'><p>",n.forEach((function(e,n){e&&(n===p&&(D+="<div class='window'><p>"),n===f&&(D+="is"===t.ty||"iss"===t.ty?"<ins>":"<del>"),"\n"===e.s?D+="</p><p>":D+=e.s,n===m&&(D+="is"===t.ty||"iss"===t.ty?"</ins>":"</del>"),n!==v&&n!==l-1||(D+="</p></div>"))})),D=(D+="</p></div>").replace(/<p><\/p>/g,"<p>&nbsp;</p>")),D+="<div class='content'><p>";var b=f-p,B=m-p;function _(){const n=t.tab&&s&&s[t.tab]?s[t.tab]:t.tab;var r={seq:e.autoincrements[i.docId]++,docId:i.docId,rendered:D,timestamp:t.timestamp,revno:t.revno,tab:n};e.indexedDB.addRevision(r,o)}n.slice(p,v+1).forEach((function(e,n){if(e){var i;if(n===b&&(D+="is"===t.ty||"iss"===t.ty?"<ins>":"<del>"),"\n"===e.s)D+="</p><p>";else i="sug"==e.ty?"<span style='color: #156226; border-top: 1px solid #156226; border-bottom: 1px solid #156226;'>"+e.s+"</span>":"sugd"==e.ty?"<span style='color:#156226; border-top: 1px solid #156226; border-bottom: 1px solid #156226; text-decoration:line-through;'><span style='color: black;'>"+e.s+"</span></span>":e.s,D+=i;n===B&&(D+="is"===t.ty||"iss"===t.ty?"</ins>":"</del>")}})),D+="</p></div>",d&&(e.windows[i.docId]=d),e.indexedDB.db?_():e.indexedDB.open().then(_)}))},e.buildRevisions=async function(n,t){chrome.tabs.query({url:'*://docs.google.com/*/'+n+'/edit*'},(function(e){chrome.tabs.sendMessage(e[0].id,{msg:'clearing'},(function(e){}))})),e.clearAllRevisionsByDocId(n,(async function(){chrome.tabs.query({url:'*://docs.google.com/*/'+n+'/edit*'},(function(e){chrome.tabs.sendMessage(e[0].id,{msg:'cleared'},(function(e){}))}));var i=t.split("\n").pop(),s=JSON.parse(i).changelog,o=s.length,r=(await e.precomputeStats(n,s)).tabNames,d={},a=function(e){const n=e.tab||"t.0";return n in d||(d[n]=[]),d[n]};e.autoincrements[n]=0,e.windows[n]=[0,2500];var c={is:function(e){for(var n=e.ibi,t=e.s,i=Array.from(t).map((function(e){return{s:e}})),s=0;s<t.length;s++)a(e).insert(i[s],n-1+s)},ds:function(e){var n=e.si,t=e.ei;a(e).delete(n-1,t-1)},iss:function(e){for(var n=e.ibi,t=e.s,i=Array.from(t).map((function(e){return{s:e,ty:"sug"}})),s=0;s<t.length;s++)a(e).insert(i[s],n-1+s)},dss:function(e){var n=e.si,t=e.ei;a(e).delete(n-1,t-1)},msfd:function(e){for(var n=e.si-1;n<=e.ei-1;n++)a(e)[n]?a(e)[n].ty="sugd":console.error("Character not found at index",n,"in setting sugd ty data, data = ",e)},mlti:async function(e){let n=0;for(const t of e.mts)t.revno||(t.revno=[e.revno,n].join('-')),t.timestamp=e.timestamp,t.uid=e.uid,await u(t),n++},nm:async function(e){let n=0;const t=e.nmc;t.revno||(t.revno=[e.revno,n].join('-')),t.timestamp=e.timestamp,t.uid=e.uid,t.tab=e.nmr[1],await u(t)},ac:async function(e){e.d&&e.d[0]&&e.d[1]&&e.d[1][1]&&(r[e.d[0]]=e.d[1][1])},ucp:async function(e){e.d&&e.d[0]&&e.d[1]&&e.d[1][1]&&e.d[1][1][1]&&(r[e.d[0]]=e.d[1][1][1])},rplc:async function(e){let n=0;for(const t of e.snapshot)t.revno||(t.revno=[e.revno,n].join('-')),t.timestamp=e.timestamp,t.uid=e.uid,await u(t),n++}},u=async function(t){var i=c[t.ty];i&&('is'==t.ty?(i(t),await e.render(a(t),t,{docId:n},r)):'ds'==t.ty?(await e.render(a(t),t,{docId:n},r),i(t)):'iss'==t.ty?(i(t),await e.render(a(t),t,{docId:n},r)):'dss'==t.ty?(await e.render(a(t),t,{docId:n},r),i(t)):'mlti'==t.ty||'nm'==t.ty||'ac'==t.ty||'ucp'==t.ty?await i(t):'msfd'==t.ty?(await e.render(a(t),t,{docId:n},r),await i(t)):'rplc'==t.ty&&await i(t))};!(async function(n,t,i){let s=0;for(const o of n){if(e.shouldKill(t))break;const n=Object.assign(o[0],{timestamp:o[1],uid:o[2],revno:o[3]});await u(n),chrome.tabs.query({url:`*://docs.google.com/*/${t}/edit*`},(function(e){e.forEach((e=>{chrome.tabs.sendMessage(e.id,{msg:'progress',so_far:s+1,out_of:i})}))})),s++}})(s,n,o)}))},e.indexedDB.open=function(){return new Promise(((n,t)=>{if(e.indexedDB.db)n(e.indexedDB.db);else{var i=indexedDB.open("revisions",7);i.onupgradeneeded=function(n){var t=n.target.result;(n.target.transaction.onerror=e.indexedDB.onerror,t.objectStoreNames.contains("revision"))||t.createObjectStore("revision",{autoIncrement:!0}).createIndex("docseq",["docId","seq"],{unique:!1});t.objectStoreNames.contains("session")||t.createObjectStore("session",{autoIncrement:!0}).createIndex("sessdocseq",["docId","seq"]);t.objectStoreNames.contains("timeline")&&t.deleteObjectStore("timeline");t.createObjectStore("timeline",{keyPath:"docId"})},i.onsuccess=function(t){e.indexedDB.db=t.target.result,n(e.indexedDB.db)},i.onerror=function(e){console.error("Error opening IndexedDB",e),t(e)}}}))},e.indexedDB.addRevision=function(n,t){var i=e.indexedDB.db.transaction(["revision"],"readwrite").objectStore("revision").put(n);i.onsuccess=function(e){t()},i.onerror=function(e){console.log(e.value)}},e.indexedDB.addSession=function(n,t){return new Promise(((i,s)=>{var o=e.indexedDB.db.transaction(["session"],"readwrite").objectStore("session").put(n);o.onsuccess=function(e){t&&t(),i(e.target.result)},o.onerror=function(e){console.log(e.value),s(e)}}))},e.indexedDB.addTimeline=function(n,t){return new Promise(((i,s)=>{var o=e.indexedDB.db.transaction(["timeline"],"readwrite").objectStore("timeline").put(n);o.onsuccess=function(e){t&&t(),i(e.target.result)},o.onerror=function(e){console.log(e.value),s(e)}}))},e.indexedDB.getAllRevisions=function(){var n=e.indexedDB.db.transaction(["revision"],"readwrite").objectStore("revision"),t=IDBKeyRange.lowerBound(0),i=n.openCursor(t);i.onsuccess=function(e){var n=e.target.result;0!=!!n&&n.continue()},i.onerror=e.indexedDB.onerror},e.indexedDB.lastRevisionByDocId=function(n,t){var i=e.indexedDB.db.transaction(["revision"],"readonly").objectStore("revision").index("docseq"),s=[n,0],o=[n,Number.MAX_VALUE],r=IDBKeyRange.bound(s,o),d=i.openCursor(r,'prev'),a=null;d.onsuccess=function(e){e.target.result?(a=e.target.result.value,t(a)):t({docId:n,seq:0})},d.onerror=e.indexedDB.onerror},e.indexedDB.lastSessionByDocId=function(n,t){var i=e.indexedDB.db.transaction(["session"],"readonly").objectStore("session").index("sessdocseq"),s=[n,0],o=[n,Number.MAX_VALUE],r=IDBKeyRange.bound(s,o),d=i.openCursor(r,'prev'),a=null;d.onsuccess=function(e){e.target.result?(a=e.target.result.value,t(a)):t({docId:n,seq:0})},d.onerror=e.indexedDB.onerror},e.indexedDB.getRevisionsByDocIdWithOffsetAndLimit=function(n,t,i,s){var o=e.indexedDB.db.transaction(["revision"],"readwrite").objectStore("revision").index("docseq"),r=[n,t],d=[n,t+i],a=IDBKeyRange.bound(r,d),c=[],u=o.openCursor(a,'next');return u.onsuccess=function(e){var n=e.target.result;n?(c.push(n.value),n.continue()):s&&s(c)},u.onerror=e.indexedDB.onerror,c},e.indexedDB.getAllSessionsByDocId=function(n,t){var i=e.indexedDB.db.transaction(["session"],"readwrite").objectStore("session").index("sessdocseq"),s=[n,0],o=[n,Number.MAX_VALUE],r=IDBKeyRange.bound(s,o),d=[],a=i.openCursor(r,'next');return a.onsuccess=function(e){var n=e.target.result;n?(d.push(n.value),n.continue()):t&&t(d)},a.onerror=e.indexedDB.onerror,d},e.indexedDB.clearAllRevisions=function(){var n=e.indexedDB.db.transaction(["revision"],"readwrite").objectStore("revision").clear();n.onsuccess=function(e){console.log('successfully cleared revisions')},n.onerror=function(e){console.log(e)}},e.clearAllRevisionsByDocId=function(n,t){e.indexedDB.lastRevisionByDocId(n,(function(i){e.indexedDB.clearAllRevisionsByDocId(n,i.seq,(function(){e.indexedDB.lastSessionByDocId(n,(function(i){e.indexedDB.clearAllSessionsByDocId(n,i.seq,(function(){e.indexedDB.clearTimelineByDocId(n,t)}))}))}))}))},e.getStatsData=function(n,t){var i={};e.indexedDB.getAllSessionsByDocId(n,(function(s){i.sessions=s,e.indexedDB.getTimeline(n,(function(e){i.timeline=e,t(i)}))}))},e.indexedDB.clearAllRevisionsByDocId=function(n,t,i){var s=e.indexedDB.db.transaction(["revision"],"readwrite").objectStore("revision"),o=s.index("docseq"),r=[n,0],d=[n,t],a=IDBKeyRange.bound(r,d),c=o.openKeyCursor(a);c.onsuccess=function(){var e=c.result;e?(s.delete(e.primaryKey),e.continue()):i&&i()}},e.indexedDB.clearAllSessionsByDocId=function(n,t,i){var s=e.indexedDB.db.transaction(["session"],"readwrite").objectStore("session"),o=s.index("sessdocseq"),r=[n,0],d=[n,t],a=IDBKeyRange.bound(r,d),c=o.openKeyCursor(a);c.onsuccess=function(){var e=c.result;e?(s.delete(e.primaryKey),e.continue()):i&&i()}},e.indexedDB.getTimeline=function(n,t){var i=e.indexedDB.db.transaction(["timeline"],"readwrite").objectStore("timeline").get(n);return i.onsuccess=function(e){t(i.result)},i.onerror=e.indexedDB.onerror,null},e.indexedDB.clearTimelineByDocId=function(n,t){var i=e.indexedDB.db.transaction(["timeline"],"readwrite").objectStore("timeline").delete(n);return i.onsuccess=function(e){t()},i.onerror=e.indexedDB.onerror,null};var t=function(){return new Promise((e=>{chrome.storage.local.get(["userChromeUUID"],(function(n){if(n.userChromeUUID)e(n.userChromeUUID);else{const n=crypto.randomUUID();chrome.storage.local.set({userChromeUUID:n},(function(){e(n)}))}}))}))},i=function(e,n){const t=e.untrusted?{userEmail:e.email,untrusted:!0,userChromeUUID:e.userChromeUUID,codepath:e.codepath}:{userEmail:e.email,userChromeUUID:e.userChromeUUID,codepath:e.codepath};e.errorReason&&(t.errorReason=e.errorReason),fetch('https://accounts.draftback.com/check-entitlement',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(t)}).then((e=>e.json())).then((t=>n(t,e.email)))};chrome.runtime.onMessage.addListener(((s,o,r)=>{switch(s.msg){case'changelog':return e.buildRevisions(s.docId,s.changelog),r('ok'),!0;case'get-revisions':return e.indexedDB.db?e.indexedDB.getRevisionsByDocIdWithOffsetAndLimit(s.docId,s.offset,s.limit,(function(e){r(e.map((function(e){return{timestamp:e.timestamp,content:e.rendered,revno:e.revno,tab:e.tab}})))})):e.indexedDB.open().then((()=>{e.indexedDB.getRevisionsByDocIdWithOffsetAndLimit(s.docId,s.offset,s.limit,(function(e){r(e.map((function(e){return{timestamp:e.timestamp,content:e.rendered,revno:e.revno,tab:e.tab}})))}))})),!0;case'get-last-revision':return e.indexedDB.db?e.indexedDB.lastRevisionByDocId(s.docId,(function(e){r(e)})):e.indexedDB.open().then((()=>{e.indexedDB.lastRevisionByDocId(s.docId,(function(e){r(e)}))})),!0;case'kill':return e.kills[s.docId]=!0,r("ok"),!0;case'clear-killed':return delete e.kills[s.docId],r("ok"),!0;case'delete':return e.indexedDB.db?e.clearAllRevisionsByDocId(s.docId,(function(){chrome.tabs.query({url:'*://docs.google.com/*/'+s.docId+'/edit*'},(function(e){chrome.tabs.sendMessage(e[0].id,{msg:'cleared'},(function(e){}))}))})):e.indexedDB.open().then((()=>{e.clearAllRevisionsByDocId(s.docId,(function(){chrome.tabs.query({url:'*://docs.google.com/*/'+s.docId+'/edit*'},(function(e){chrome.tabs.sendMessage(e[0].id,{msg:'cleared'},(function(e){}))}))}))})),!0;case'check-entitlement':return r({entitlementStatus:{has_active_subscription:true},client_reference_id:"free"}),!0;case'sign-in':return r({entitlementStatus:{has_active_subscription:true},client_reference_id:"free"}),!0;case'sign-in-manually':return r({entitlementStatus:{has_active_subscription:true},client_reference_id:"free"}),!0;case'preview':return chrome.tabs.create({url:"/playback.html?docId="+s.docId}),r("ok"),!0;case'set-author-map':return e.authorMaps[s.docId]=s.authorMap,r("ok"),!0;case'stats':return chrome.tabs.create({url:"/stats.html?docId="+s.docId}),r("ok"),!0;case'get-stats-data':return e.indexedDB.db?e.getStatsData(s.docId,(function(n){r({sessions:n.sessions,authorMap:e.authorMaps[s.docId],timeline:n.timeline})})):e.indexedDB.open().then((()=>{e.getStatsData(s.docId,(function(n){r({sessions:n.sessions,authorMap:e.authorMaps[s.docId],timeline:n.timeline})}))})),!0;default:return console.log(s),!0}})),self.addEventListener('activate',(n=>{n.waitUntil(e.indexedDB.open())})),self.addEventListener('message',(e=>{e.data&&'terminate'===e.data.type&&self.registration.unregister()})),self.addEventListener('install',(n=>{n.waitUntil(e.indexedDB.open())}));