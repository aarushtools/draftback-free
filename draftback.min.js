var e,t=jQuery.noConflict();window.draftback=window.draftback||{},t.extend(window.draftback,{firstMark:[],getDocId:function(){return/\/document\/d\/(.*?)\//g.exec(location.pathname)[1]},getDocTitle:function(){return document.title.split(" - ")[0]},setToken:function(e){draftback.token||(draftback.token=e,draftback.getRevisionCount())},setEmail:function(e){draftback.email||(draftback.email=e)},setRevisionCount:function(e){draftback.revisionCount=(''+e).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"),t('#revision-count').text(draftback.revisionCount)},setAuthorMap:function(e){chrome.runtime.sendMessage({msg:'set-author-map',docId:draftback.getDocId(),authorMap:e},(function(e){}))},updateProgress:function(e,a){if(t("#so_far").text(Math.min(e,a)),t("#out_of").text(a),e%50==0){var o=draftback.firstMark,i=[e,(new Date).getTime()];if(o.length){var s=(a-e)/(i[0]-o[0])*(i[1]-o[1]),n=moment.duration(s);if(n.asMilliseconds()<6e4)if(n.asMilliseconds()>3e4)var r='about a minute';else r='a few seconds';else r=n.humanize();t(".time-col").text(r+" left")}else draftback.firstMark=i}e>=a-1&&(t(".upload-file:first").addClass("complete"),t(".time-col").html('<img src="https://cloud.githubusercontent.com/assets/21294/4967993/00bf782e-682d-11e4-93e7-106fcf26f6a0.gif" class="sprite sprite_web s_web_s_check">'),t("a.dest").text('View').show(),e=!0),t(".upload-progress-bar").css("width",e/a*100+'%')},disable:function(){t("#draftback").addClass('jfk-button-disabled').attr('data-tooltip','Draftback is only available on docs you have permission to edit').attr('aria-label','Draftback is only available on docs you have permission to edit').attr('disabled','disabled').attr('aria-disabled','disabled').html('Draftback unavailable')},getRevisionCount:function(){var e=t("meta[itemprop='url']").attr("content").match(/^(https:\/\/docs\.google\.com.*?\/document(?:\/u\/\d+)?\/d\/)/)[1],a=draftback.getDocId(),o=e+a+"/revisions/tiles?id="+a+"&start=1&showDetailedRevisions=false&token="+draftback.token;t.ajax({type:"get",url:o,headers:{"x-same-domain":1},error:function(e,a,o){if(200==e.status){var i=e.responseText,s=JSON.parse(i.split("\n")[1]),n={};t.each(s.userMap,(function(e,t){n[''+e]=t.name}));var r=s.tileInfo[s.tileInfo.length-1].end;draftback.setAuthorMap(n),draftback.setRevisionCount(r)}else 403==e.status?draftback.disable():500==e.status&&(draftback.setRevisionCount(0),t("#draftback").addClass('jfk-button-disabled').attr('data-tooltip','Draftback will become available once you make changes').attr('aria-label','Draftback will become available once you make changes').attr('disabled','disabled').attr('aria-disabled','disabled').html('Draftback unavailable'))},success:function(e){console.log(e)}})},getChangelog:function(){var e=t("meta[itemprop='url']").attr("content").match(/^(https:\/\/docs\.google\.com.*?\/document(?:\/u\/\d+)?\/d\/)/)[1],a=draftback.getDocId(),o=e+a+"/revisions/load?id="+a+"&start=1&end="+parseInt((''+draftback.revisionCount).replace(/,/g,''))+"&token="+draftback.token;t.ajax({type:"get",url:o,headers:{"x-same-domain":1},error:function(e,t,a){var o=e.responseText;chrome.runtime.sendMessage({msg:'changelog',docId:draftback.getDocId(),changelog:o},(function(e){}))},success:function(e){console.log(e)}})}});var a=function(e){const t=new Date(e),a=new Date,o=Math.floor((t-a)/1e3),i=Math.abs(o),s=[{name:'year',seconds:31536e3},{name:'month',seconds:2592e3},{name:'day',seconds:86400},{name:'hour',seconds:3600},{name:'minute',seconds:60},{name:'second',seconds:1}];for(const e of s)if(i>=e.seconds){const t=Math.floor(i/e.seconds),a=1===t?'':'s',s=o>=0?'from now':'ago';return`${t} ${e.name}${a} ${s}`}return'just now'};t(document).ready((function(){var o,i,s,n;o='injected.js',i='body',s=document.getElementsByTagName(i)[0],(n=document.createElement('script')).setAttribute('type','text/javascript'),n.setAttribute('src',chrome.runtime.getURL(o)),s.appendChild(n),window.addEventListener('tokenExtracted',(function(e){const t=e.detail.token,a=e.detail.email;draftback.setToken(t),draftback.setEmail(a)}));var r=t('<div role="button" id="draftback" class="goog-inline-block jfk-button jfk-button-standard docs-titlebar-button" aria-disabled="false" aria-pressed="false" tabindex="0" data-tooltip="Play back this document\'s history" aria-label="Play back this document\'s history" alt="Draftback: Play back this document\'s history" value="undefined" style="-webkit-user-select: none;">Draftback (<span style="padding-right: 2px;" id="revision-count">'+(draftback.revisionCount||'<img src="https://cloud.githubusercontent.com/assets/21294/4969053/0b7748bc-6857-11e4-9985-89b361f919f8.gif"/>')+'</span> revs)</div>');r.prependTo(t('.docs-titlebar-buttons'));r.before('<div id="draftback-message" style="display: none;"><span>Processing changelog...</span> <img src="https://cloud.githubusercontent.com/assets/21294/4968082/0933ba06-6832-11e4-9039-f5877fca316b.gif"/></div>'),t('#draftback').live('click',(function(){return'disabled'==t(this).attr('disabled')||(t("#progress").removeClass('killed'),chrome.runtime.sendMessage({msg:'clear-killed',docId:draftback.getDocId()},(function(e){})),t('#draftback-box:visible').length?t('#draftback-box').hide():chrome.runtime.sendMessage({msg:'get-last-revision',docId:draftback.getDocId()},(function(e){e.seq>0?(t('#existing-revisions-count').text((''+parseInt(e.revno)).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")),t('#draftback-box').show()):(t('#draftback-message').show(),draftback.getChangelog())}))),!1})),t('#draftback-box .docos-new-comment-button').live('click',(function(){switch(t('#draftback-box').hide(),t("#progress").removeClass('killed'),chrome.runtime.sendMessage({msg:'clear-killed',docId:draftback.getDocId()},(function(e){})),t(this).attr('draftback-action')){case'rerender':t('#draftback-message').show(),draftback.getChangelog();break;case'playback':e?chrome.runtime.sendMessage({msg:'preview',docId:draftback.getDocId()},(function(e){})):(t('#draftback-message').show(),draftback.getChangelog());break;case'delete':t('#draftback-message').show().find('span').text('Clearing existing revisions...'),chrome.runtime.sendMessage({msg:'delete',docId:draftback.getDocId()},(function(e){}))}return!1})),t('<div class="docs-docos-activitybox docos-enable-new-header" id="draftback-box" aria-label="Draftback box" tabindex="0" style="display: none;"> <div class="docs-docos-activitybox-inner" dir="ltr" style="text-align: left;"> <div class="docos docos-streampane-container docos-enable-docs-header" tabindex="0"> <div class="docos-streampane-content"> <div class="docos-streampane-header"> <div class="docos-new-comment-button jfk-button jfk-button-standard" role="button" data-tooltip="Play back the history Draftback has already rendered for this doc" aria-label="Play back the history Draftback has already rendered for this doc" draftback-action="playback" aria-disabled="false" tabindex="0" style="-webkit-user-select: none;"> <div class="docos-new-comment-icon docos-icon-insert-comment docos-icon"></div>Play <span id="existing-revisions-count">57</span> stored revisions </div><div class="docos-new-comment-button jfk-button jfk-button-standard" role="button" data-tooltip="Delete the revisions Draftback has stored for this doc" aria-label="Delete the revisions Draftback has stored for this doc" draftback-action="delete" aria-disabled="false" tabindex="0" style="-webkit-user-select: none;"> <div class="docos-new-comment-icon docos-icon-insert-comment docos-icon"></div>Delete </div><div class="docos-new-comment-button jfk-button jfk-button-standard" role="button" data-tooltip="Re-render revisions for this doc (if there are more to add, for instance)" aria-label="Re-render revisions for this doc (if there are more to add, for instance)" draftback-action="rerender" aria-disabled="false" tabindex="0" style="-webkit-user-select: none;"> <div class="docos-new-comment-icon docos-icon-insert-comment docos-icon"></div>Re-render </div> </div> </div> </div> </div> </div>').appendTo(t('body')),t('#draftback-box .docos-new-comment-button').live('mouseover',(function(){t(this).addClass('jfk-button-hover')})),t('#draftback-box .docos-new-comment-button').live('mouseout',(function(){t(this).removeClass('jfk-button-hover')})),t('<div id="modal-overlay" style="display: none;">').appendTo(t('body'));var d=draftback.getDocId();d=d.slice(0,10)+'...'+d.slice(35,45),t('<div id="progress" style="display: none;"><div id="modal-box"><a href="#" id="modal-x"></a><h2 id="modal-title">Rendering Draftback for "'+draftback.getDocTitle()+'"</h2><div id="modal-content" style="height: auto;"><div><ol id="upload-files-list"><li class="upload-file"><div class="upload-progress-bar"></div><div class="upload-file-info"><div class="filename-col"><img src="https://cloud.githubusercontent.com/assets/21294/4967993/00bf782e-682d-11e4-93e7-106fcf26f6a0.gif" class="sprite sprite_web s_web_page_white_word"> <span class="filename">'+d+'</span> <span class="size">- <span id="so_far">0</span>/<span id="out_of">0</span> revs</span></div><div class="dest-col"><a href="#" class="dest" style="display: inline-block;">Preview</a></div><div class="status-col"></div><div class="time-col">estimating time left</div><br class="clear"></div></li></ol></div></div></div></div>').appendTo(t('body')),t("a.dest").live('click',(function(){return chrome.runtime.sendMessage({msg:'preview',docId:draftback.getDocId()},(function(e){})),!1}));var c=function(o){e=!0,t("a.dest").show()};e=!0;t("a.dest").show();t("#modal-x").live('click',(function(){return chrome.runtime.sendMessage({msg:'kill',docId:draftback.getDocId()},(function(e){})),t("#modal-overlay").hide(),t("#progress").addClass('killed').hide(),!1}))})),chrome.runtime.onMessage.addListener((function(e,a,o){switch(e.msg){case'token':draftback.setToken(e.token);break;case'cleared':t('#draftback-message').hide().find('span').text('Processing changelog...');break;case'clearing':t('#draftback-message').show().find('span').text('Clearing existing revisions...');break;case'progress':t('#progress').hasClass('killed')||(t("#progress").show(),t("#modal-overlay").show()),draftback.updateProgress(e.so_far,e.out_of);break;default:console.log(e)}o("ok")}));