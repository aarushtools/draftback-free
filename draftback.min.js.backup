var e,t=jQuery.noConflict();window.draftback=window.draftback||{},t.extend(window.draftback,{firstMark:[],getDocId:function(){return/\/document\/d\/(.*?)\//g.exec(location.pathname)[1]},getDocTitle:function(){return document.title.split(" - ")[0]},setToken:function(e){draftback.token||(draftback.token=e,draftback.getRevisionCount())},setEmail:function(e){draftback.email||(draftback.email=e)},setRevisionCount:function(e){draftback.revisionCount=(''+e).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"),t('#revision-count').text(draftback.revisionCount)},setAuthorMap:function(e){chrome.runtime.sendMessage({msg:'set-author-map',docId:draftback.getDocId(),authorMap:e},(function(e){}))},updateProgress:function(e,a){if(t("#so_far").text(Math.min(e,a)),t("#out_of").text(a),e%50==0){var o=draftback.firstMark,i=[e,(new Date).getTime()];if(o.length){var s=(a-e)/(i[0]-o[0])*(i[1]-o[1]),n=moment.duration(s);if(n.asMilliseconds()<6e4)if(n.asMilliseconds()>3e4)var r='about a minute';else r='a few seconds';else r=n.humanize();t(".time-col").text(r+" left")}else draftback.firstMark=i}e>=a-1&&(t(".upload-file:first").addClass("complete"),t(".time-col").html('<img src="https://cloud.githubusercontent.com/assets/21294/4967993/00bf782e-682d-11e4-93e7-106fcf26f6a0.gif" class="sprite sprite_web s_web_s_check">'),t("a.dest").text('View')),t(".upload-progress-bar").css("width",e/a*100+'%')},disable:function(){t("#draftback").addClass('jfk-button-disabled').attr('data-tooltip','Draftback is only available on docs you have permission to edit').attr('aria-label','Draftback is only available on docs you have permission to edit').attr('disabled','disabled').attr('aria-disabled','disabled').html('Draftback unavailable')},getRevisionCount:function(){var e=t("meta[itemprop='url']").attr("content").match(/^(https:\/\/docs\.google\.com.*?\/document(?:\/u\/\d+)?\/d\/)/)[1],a=draftback.getDocId(),o=e+a+"/revisions/tiles?id="+a+"&start=1&showDetailedRevisions=false&token="+draftback.token;t.ajax({type:"get",url:o,headers:{"x-same-domain":1},error:function(e,a,o){if(200==e.status){var i=e.responseText,s=JSON.parse(i.split("\n")[1]),n={};t.each(s.userMap,(function(e,t){n[''+e]=t.name}));var r=s.tileInfo[s.tileInfo.length-1].end;draftback.setAuthorMap(n),draftback.setRevisionCount(r)}else 403==e.status?draftback.disable():500==e.status&&(draftback.setRevisionCount(0),t("#draftback").addClass('jfk-button-disabled').attr('data-tooltip','Draftback will become available once you make changes').attr('aria-label','Draftback will become available once you make changes').attr('disabled','disabled').attr('aria-disabled','disabled').html('Draftback unavailable'))},success:function(e){console.log(e)}})},getChangelog:function(){var e=t("meta[itemprop='url']").attr("content").match(/^(https:\/\/docs\.google\.com.*?\/document(?:\/u\/\d+)?\/d\/)/)[1],a=draftback.getDocId(),o=e+a+"/revisions/load?id="+a+"&start=1&end="+parseInt((''+draftback.revisionCount).replace(/,/g,''))+"&token="+draftback.token;t.ajax({type:"get",url:o,headers:{"x-same-domain":1},error:function(e,t,a){var o=e.responseText;chrome.runtime.sendMessage({msg:'changelog',docId:draftback.getDocId(),changelog:o},(function(e){}))},success:function(e){console.log(e)}})}});var a=function(e){const t=new Date(e),a=new Date,o=Math.floor((t-a)/1e3),i=Math.abs(o),s=[{name:'year',seconds:31536e3},{name:'month',seconds:2592e3},{name:'day',seconds:86400},{name:'hour',seconds:3600},{name:'minute',seconds:60},{name:'second',seconds:1}];for(const e of s)if(i>=e.seconds){const t=Math.floor(i/e.seconds),a=1===t?'':'s',s=o>=0?'from now':'ago';return`${t} ${e.name}${a} ${s}`}return'just now'};t(document).ready((function(){var o,i,s,n;o='injected.js',i='body',s=document.getElementsByTagName(i)[0],(n=document.createElement('script')).setAttribute('type','text/javascript'),n.setAttribute('src',chrome.runtime.getURL(o)),s.appendChild(n),window.addEventListener('tokenExtracted',(function(e){const t=e.detail.token,a=e.detail.email;draftback.setToken(t),draftback.setEmail(a)}));var r=t('<div role="button" id="draftback" class="goog-inline-block jfk-button jfk-button-standard docs-titlebar-button" aria-disabled="false" aria-pressed="false" tabindex="0" data-tooltip="Play back this document\'s history" aria-label="Play back this document\'s history" alt="Draftback: Play back this document\'s history" value="undefined" style="-webkit-user-select: none;">Draftback (<span style="padding-right: 2px;" id="revision-count">'+(draftback.revisionCount||'<img src="https://cloud.githubusercontent.com/assets/21294/4969053/0b7748bc-6857-11e4-9985-89b361f919f8.gif"/>')+'</span> revs)</div>');r.prependTo(t('.docs-titlebar-buttons'));r.before('<div id="draftback-message" style="display: none;"><span>Processing changelog...</span> <img src="https://cloud.githubusercontent.com/assets/21294/4968082/0933ba06-6832-11e4-9039-f5877fca316b.gif"/></div>'),t('#draftback').live('click',(function(){return chrome.storage.local.get(["userEmail"],(function(e){e.userEmail?(t(".solicitation").hide(),chrome.runtime.sendMessage({msg:'check-entitlement',userEmail:e.userEmail},(function(e){c(e)}))):(t("#entitlement-loader").hide(),t(".solicitation").show())})),'disabled'==t(this).attr('disabled')||(t("#progress").removeClass('killed'),chrome.runtime.sendMessage({msg:'clear-killed',docId:draftback.getDocId()},(function(e){})),t('#draftback-box:visible').length?t('#draftback-box').hide():chrome.runtime.sendMessage({msg:'get-last-revision',docId:draftback.getDocId()},(function(e){e.seq>0?(t('#existing-revisions-count').text((''+parseInt(e.revno)).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")),t('#draftback-box').show()):(t('#draftback-message').show(),draftback.getChangelog())}))),!1})),t('#draftback-box .docos-new-comment-button').live('click',(function(){switch(t('#draftback-box').hide(),t("#progress").removeClass('killed'),chrome.runtime.sendMessage({msg:'clear-killed',docId:draftback.getDocId()},(function(e){})),t(this).attr('draftback-action')){case'rerender':t('#draftback-message').show(),draftback.getChangelog();break;case'playback':e?chrome.runtime.sendMessage({msg:'preview',docId:draftback.getDocId()},(function(e){})):(t('#draftback-message').show(),draftback.getChangelog());break;case'delete':t('#draftback-message').show().find('span').text('Clearing existing revisions...'),chrome.runtime.sendMessage({msg:'delete',docId:draftback.getDocId()},(function(e){}))}return!1})),t('<div class="docs-docos-activitybox docos-enable-new-header" id="draftback-box" aria-label="Draftback box" tabindex="0" style="display: none;"> <div class="docs-docos-activitybox-inner" dir="ltr" style="text-align: left;"> <div class="docos docos-streampane-container docos-enable-docs-header" tabindex="0"> <div class="docos-streampane-content"> <div class="docos-streampane-header"> <div class="docos-new-comment-button jfk-button jfk-button-standard" role="button" data-tooltip="Play back the history Draftback has already rendered for this doc" aria-label="Play back the history Draftback has already rendered for this doc" draftback-action="playback" aria-disabled="false" tabindex="0" style="-webkit-user-select: none;"> <div class="docos-new-comment-icon docos-icon-insert-comment docos-icon"></div>Play <span id="existing-revisions-count">57</span> stored revisions </div><div class="docos-new-comment-button jfk-button jfk-button-standard" role="button" data-tooltip="Delete the revisions Draftback has stored for this doc" aria-label="Delete the revisions Draftback has stored for this doc" draftback-action="delete" aria-disabled="false" tabindex="0" style="-webkit-user-select: none;"> <div class="docos-new-comment-icon docos-icon-insert-comment docos-icon"></div>Delete </div><div class="docos-new-comment-button jfk-button jfk-button-standard" role="button" data-tooltip="Re-render revisions for this doc (if there are more to add, for instance)" aria-label="Re-render revisions for this doc (if there are more to add, for instance)" draftback-action="rerender" aria-disabled="false" tabindex="0" style="-webkit-user-select: none;"> <div class="docos-new-comment-icon docos-icon-insert-comment docos-icon"></div>Re-render </div> </div> </div> </div> </div> </div>').appendTo(t('body')),t('#draftback-box .docos-new-comment-button').live('mouseover',(function(){t(this).addClass('jfk-button-hover')})),t('#draftback-box .docos-new-comment-button').live('mouseout',(function(){t(this).removeClass('jfk-button-hover')})),t('<div id="modal-overlay" style="display: none;">').appendTo(t('body'));var d=draftback.getDocId();d=d.slice(0,10)+'...'+d.slice(35,45),t('<div id="progress" style="display: none;"><div id="modal-box"><a href="#" id="modal-x"></a><h2 id="modal-title">Rendering Draftback for "'+draftback.getDocTitle()+'"</h2><div id="modal-content" style="height: auto;"><div id="entitlement-loader" style="margin-top: -20px; line-height: 19px; margin-bottom: 10px;"><img src="https://cloud.githubusercontent.com/assets/21294/4969053/0b7748bc-6857-11e4-9985-89b361f919f8.gif" style="  position: relative; top: 3px; margin-right: 5px;"/>Checking account status...</div><div class="solicitation" style="margin-top: -20px; line-height: 19px; margin-bottom: 10px;"><span style="font-weight: bold;">Hi there!</span> After ten years I have decided to start charging for Draftback. You can <a href="https://draftback.com/#paid" target="_blank">read more</a> about this decision. All users will have a one-month free trial. <br><br>To get started, <a class="sign-in" href="#" style="font-weight: bold;">Connect your Google account</a>. You only have to do this once. All this does is give me permission to see your email address so I can check it against a database. <input class="sign-in" type="button" value="Connect your Google account"></div><div id="error" style="display: none; margin-top: -20px; line-height: 19px; margin-bottom: 10px; font-size: 14px;"></div><div id="must-pay" style="display: none; margin-top: -20px; line-height: 19px; margin-bottom: 10px; font-size: 14px;">Your free trial is over.<span class="trial_end_date"></span> <a class="pricing-link" href="#" target="_blank" style="border-bottom: 1px solid rgb(40, 149, 241);">Subscribe now</a>. For assistance, contact support@draftback.com.</div><div id="trial" style="display: none; margin-top: -20px; line-height: 19px; margin-bottom: 10px; font-size: 14px;">You are currently in a free trial. It ends <span id="duration"></span>. <a href="https://draftback.com/#pricing" class="pricing-link" target="_blank" style="border-bottom: 1px solid rgb(40, 149, 241); background-color: rgb(0, 116, 212); padding: 6px; color: white; border-radius: 4px;">Subscribe here</a><br><br>Click the "View" link below to see your document playback.</div><div><ol id="upload-files-list"><li class="upload-file"><div class="upload-progress-bar"></div><div class="upload-file-info"><div class="filename-col"><img src="https://cloud.githubusercontent.com/assets/21294/4967993/00bf782e-682d-11e4-93e7-106fcf26f6a0.gif" class="sprite sprite_web s_web_page_white_word"> <span class="filename">'+d+'</span> <span class="size">- <span id="so_far">0</span>/<span id="out_of">0</span> revs</span></div><div class="dest-col"><a href="#" class="dest" style="display: none;">Preview</a><a id="subscribe_button" href="#" target="_blank" style="display: inline-block;text-decoration: none !important;font-size: 13px !important;padding: 6px 15px !important;background-color: rgb(220, 38, 38) !important;color: white !important;border: none !important;border-radius: 4px !important;cursor: pointer !important;line-height: 1.5 !important;text-transform: none !important;height: 18px;width: 92px;margin-top: 2px;">Subscribe now</a></div><div class="status-col"></div><div class="time-col">estimating time left</div><br class="clear"></div></li></ol></div></div></div></div>').appendTo(t('body')),t("#subscribe_button").hide(),t("a.dest").live('click',(function(){return e&&chrome.runtime.sendMessage({msg:'preview',docId:draftback.getDocId()},(function(e){})),!1}));var c=function(o){t("#entitlement-loader").hide(),o?.entitlementStatus?.has_active_subscription?(e=!0,t("a.dest").show(),t("#must-pay").hide(),t("#error").hide(),t("#subscribe_button").hide()):o?.entitlementStatus?.trial_details?.trial_active?(e=!0,t("a.dest").show(),t("#must-pay").hide(),t("#error").hide(),t("#subscribe_button").hide(),t("#trial span#duration").html(a(o.entitlementStatus.trial_details.trial_end_date)),t("#trial .pricing-link").attr("href",`https://draftback.com/?ref=${o.client_reference_id}#pricing`),t("#trial").show()):o&&o.error?(e=!1,t(".solicitation").hide(),t("#must-pay").hide(),draftback.email?(t("#error").html("There was an error authenticating via Google: <code id='error-reason' style='color: indianred;'>"+o.error+"</code>. As a fallback, Draftback has detected your email address from the current page: <code id='manual_email_trusted' style='font-weight: bold;'>"+draftback.email+"</code>. If that is correct, you can submit it below to log in.<br><input id='manual_email_trusted_submit' type='button' value='Submit'></input><br><br> <small>Draftback will store your email address on the Draftback server and within the Chrome extension in order to check the status of your subscription or free trial.</small>"),t("#error").show()):(t("#error").html("There was an error authenticating via Google: <code id='error-reason' style='color: indianred;'>"+o.error+"</code>. As a fallback, you can enter and submit your email address manually. <br><input id='manual_email_untrusted' type='email' placeholder='you@example.com' autofocus></input> <input id='manual_email_untrusted_submit' type='button' value='Submit'></input><br><br> <small>Draftback will store your email address on the Draftback server and within the Chrome extension in order to check the status of your subscription or free trial.</small>"),t("#error").show())):o?(e=!1,t("#error").hide(),o?.entitlementStatus?.trial_details?.trial_end_date&&t("#must-pay .trial_end_date").html(" It ended "+a(o.entitlementStatus.trial_details.trial_end_date)+". "),t("#must-pay .pricing-link").attr("href",`https://draftback.com/?ref=${o.client_reference_id}#pricing`),t("#must-pay").show(),t("#subscribe_button").show(),t("#subscribe_button").attr("href",`https://draftback.com/?ref=${o.client_reference_id}#pricing`)):(e=!1,t(".solicitation").hide(),t("#must-pay").html("Something is wrong. Contact support@draftback.com for assistance."),t("#must-pay").show())};t(".sign-in").live('click',(function(){return t("#entitlement-loader").show(),t(".solicitation").hide(),chrome.runtime.sendMessage({msg:'sign-in',docId:draftback.getDocId()},(function(e){c(e)})),!1}));var l=function(e){t("#entitlement-loader").show();var a=e?t("#manual_email_untrusted").val():t("#manual_email_trusted").html(),o=t("#error-reason").html();chrome.runtime.sendMessage({msg:'sign-in-manually',manualEmail:a,untrusted:e,errorReason:o},(function(e){c(e)})),t("#must-pay").hide()};t("#manual_email_untrusted_submit").live('click',(function(){return l(!0),!1})),t("#manual_email_untrusted").live('keypress',(function(e){if(13===e.which)return l(!0),!1})),t("#manual_email_trusted_submit").live('click',(function(){return l(!1),!1})),t("#modal-x").live('click',(function(){return t(".solicitation").hide(),chrome.runtime.sendMessage({msg:'kill',docId:draftback.getDocId()},(function(e){})),t("#modal-overlay").hide(),t("#progress").addClass('killed').hide(),!1}))})),chrome.runtime.onMessage.addListener((function(e,a,o){switch(e.msg){case'token':draftback.setToken(e.token);break;case'cleared':t('#draftback-message').hide().find('span').text('Processing changelog...');break;case'clearing':t('#draftback-message').show().find('span').text('Clearing existing revisions...');break;case'progress':t('#progress').hasClass('killed')||(t("#progress").show(),t("#modal-overlay").show()),draftback.updateProgress(e.so_far,e.out_of);break;default:console.log(e)}o("ok")}));